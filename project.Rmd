
#KIDNEY HIHJUHHALA

```{r setup, cache=FALSE, echo=FALSE, results='asis'}

```


```
library(knitr)     ## required for "knitting" from Rmd to md
library(markdown)  ## required for processing from md to HTML
knit2html("~/Dropbox/Home/Documentos/MASTER/IEO/KIDNEY/project.Rmd")  ## process Rmd to HTML
browseURL("projectTemplate.html") ## open the resulting HTML file from R
```

## Loading DATA
```{r}
library(SummarizedExperiment)

se <- readRDS(file.path("~/Documentos/MASTER/IEO/KIDNEY/seKIRC.rds"))

se
```

## Explore phenotypic data

```{r}
dim(colData(se))
colData(se)[1:5, 1:5]
mcols(colData(se), use.names=TRUE)
```

## Explore feature data
```{r}
rowRanges(se)
```


## DGE object
```{r}
library(edgeR)

dge <- DGEList(counts=assays(se)$counts, genes=mcols(se))
assays(se)$logCPM <- cpm(dge, log=TRUE, prior.count=0.5)
```


# QUALITY & NORMALIZATION
```{r}
dgenorm <- calcNormFactors(dge)
assays(se)$logCPMnorm <- cpm(dgenorm, log=TRUE, prior.count=0.5)
```

## Remove paired samples

EXPLICACION

```{r}
normal.samples <- se[,se$type == "normal"]
tumor.samples  <- se[,se$type == "tumor"]

dge.normal <- DGEList(counts=assays(normal.samples)$counts, genes=mcols(normal.samples))
dge.tumor  <- DGEList(counts=assays(tumor.samples)$counts, genes=mcols(tumor.samples))

normal.samples <- rownames(dge.normal$samples)
tumor.samples  <- rownames(dge.tumor$samples)

common.samples <- intersect(normal.samples,tumor.samples)
common.samples

dge.filt <- dge[, !rownames(dge$samples) %in% common.samples]
```


## Library size

```{r}
library(ggplot2)

libsize <- data.frame(libsize = dge$sample$lib.size/1e6, type = se$type)

summary(libsize)


ggplot(libsize) +
  geom_density(aes(x=libsize, fill=type), alpha=0.5) +
  ylab("density\n") + xlab("\nMillions of Reads") +
  theme_bw()

ggplot(libsize) +
  geom_histogram(
    aes(x=libsize, fill=type, y = (..count..)/sum(..count..)), alpha=0.5, binwidth=3
  ) + xlab("\nMillions of Reads") + ylab("% of Samples\n") + theme_bw()

dge.filt <- dge.filt[, dge.filt$sample$lib.size/1e6 > 50 & dge.filt$sample$lib.size/1e6 < 70]


final.samples <- rownames(dge.filt$samples)

se.filt <-se[,colnames(se) %in% final.samples]

summary(se.filt$samples)


```



#### AFTER SAMPLES FILTERING
```{r}

summary(se.filt$type)

ggplot(libsize) +
  geom_histogram(
    aes(x=libsize, fill=type, y = (..count..)/sum(..count..)), alpha=0.5, binwidth=3
  ) + xlab("\nMillions of Reads") + ylab("% of Samples\n") + theme_bw() + xlim(c(25, 71))

ggplot(libsize) +
  geom_density(aes(x=libsize, fill=type), alpha=0.5) +
  ylab("density\n") + xlab("\nMillions of Reads") +
  theme_bw() + xlim(c(25, 71))

```


### GENES FILTERING: Distribution of expression levels among genes
```{r}
library(geneplotter)
par(mfrow=c(1,2), mar=c(4,5,1,1))
```
### Distribution of expression levels (All samples)
```{r}
multidensity(as.list(as.data.frame(assays(se.filt)$logCPMnorm)), xlab = "log2 CPM", legend = NULL, main = "All samples", cex.axis = 1.2, cex.lab = 1.5, las = 1)
```

## Expression levels comparison between normal and tumor
```{r}
normalCPMnorm <- se.filt[,se.filt$type == "normal"]
tumorCPMnorm <- se.filt[,se.filt$type == "tumor"]
multidensity(as.list(as.data.frame(assays(normalCPMnorm)$logCPMnorm)), xlab = "log2 CPM", legend = NULL, main = "Normal", cex.axis = 1.2, cex.lab = 1.5, las = 1)
multidensity(as.list(as.data.frame(assays(tumorCPMnorm)$logCPMnorm)), xlab = "log2 CPM", legend = NULL, main = "Tumor", cex.axis = 1.2, cex.lab = 1.5, las = 1)
```


### Distribution of expression levels among genes
```{r}
genemean <- data.frame(Means=rowMeans(assays(se.filt)$logCPM[,-1]))

ggplot(genemean) +
  geom_bar(aes(x=Means), binwidth = 1, fill="white", color="black") +
  theme_bw() + xlab("\nlog2CPM") + ylab("Count\n") +
  geom_vline(xintercept=mean(genemean$Means), color="red")
```
#### Gene Filter by expression level
```{r}
avgexp <- rowMeans(assays(se.filt)$logCPM)
mask <- avgexp > mean(genemean$Means)

dim(se.filt) # Before filtering SE
se.filt.genes <- se.filt[mask, ]
dim(se.filt.genes) # After filtering SE

dim(dge.filt) # Before filtering DGE
dge.filt <- dge.filt[mask, ]
dim(dge.filt) # After filtering DGE

```

## MA-plots

```{r maPlotsTumor, fig.height=36, fig.width=10, dpi=100, echo=FALSE, fig.cap="Figure S4: MA-plots of the normal samples."}
par(mfrow=c(12, 3 ), mar=c(4, 4, 3, 1))
setmp <- se.filt.genes[, se.filt.genes$type == "normal"]
dgetmp <- dge.filt[, se.filt.genes$type == "normal"]
for (i in 1:ncol(setmp)) {
  A <- rowMeans(assays(setmp)$logCPMnorm)
  M <- assays(setmp)$logCPMnorm[, i] - A
  samplename <- substr(as.character(setmp$bcr_patient_barcode[i]), 1, 12)
  smoothScatter(A, M, main=samplename, las=1)
  abline(h=0, col="blue", lwd=2)
  lo <- lowess(M ~ A)
  lines(lo$x, lo$y, col="red", lwd=2)
}
```

